# Extracts data from page and saves it to Obsidian vault
# via https://github.com/coddingtonbear/obsidian-local-rest-api
#
# Expects defined `token`, `title`, `content` constants.
#
# Optional constants: `obsidian-url`, `folder-path`.
#
$op: sys.define
functions:
  obsidianRequest:
    $op: sys.exec
    op: http.request
    config:
      $op: update
      properties:
        url:
          $op: str.join
          values:
            - $op: sys.get
              key: obsidian-url
              # Address of your Obsidian REST API
              default: http://127.0.0.1:27123
            - $op: get
              key: path
        headers:
          $op: update
          properties:
            Authorization:
              $op: str.join
              values:
                - "Bearer "
                - $op: sys.get
                  key: token
          source:
            $op: get
            key: headers
            default: {}
for:
  $op: sys.call
  fn: obsidianRequest
  arg:
    method: POST
    path:
      $op: str.join
      values:
        - $op: sys.get
          key: folder-path
          # This path will save file to the `web` folder
          default: /vault/web/
        - $op: str.replaceByRegExp
          value:
            $op: sys.get
            key: title
          pattern: "[/\\?%*:|\"<>#]"
          replacement: ""
        - ".md"
    headers:
      Content-Type: text/markdown
    body:
      $op: sys.get
      key: content
